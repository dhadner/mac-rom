#
#	File:		BBSStartup
#
#	Written by:	Kurt Clark
#
#	Copyright:	Е 1993 by Apple Computer, Inc., all rights reserved.
#
#	Change History (most recent first):
#
#	   <SM6>	10/13/93	IH		Check shell variable BlockSuperMarioSetKeys and do not call
#									setkeys if it is set (I was already using these keys).
#	   <SM5>	 6/14/93	kc		Fix some quoting problems
#	   <SM4>	 5/21/93	kc		Move UseToolServer check to after the control keys are set, fix
#									lookup entrypoint so that it will work with Ludwig sources.
#	   <SM3>	  3/3/93	kc		Fix toolserver so that it isn't launched by default.
#	   <SM2>	 2/24/93	kc		Change default tools server worksheet to TSWorkSheet.
#	   <SM1>	2/19/93		kc		Rewrite existing BBSStartup.
#
#

#
#	Variables
#	
	Set TheNameFile "{Sources}SuperMarioSources:Names"
	Export TheNameFile

	If	!"{ToolServer}"
		Set ToolServer "ToolServer"
		Export ToolServer
	End
	
	If	!{TSWorkSheet}
		Set TSWorkSheet "{MPW}TSWorkSheet"
		Export TSWorkSheet
	End


#
#	Aliases	
#	

	Alias	Nothing		"Set Status 0"					# For convenience.
	
	Alias	ToolServer	"RShell -r Х"{ToolServer}Х" ии Х"{TSWorkSheet}Х""

#
#	Keys	
#
#
# Give a chance to block these keys if we don't want them.
#
	If !{BlockSuperMarioSetKeys}

		# Make sure the MPW Shell supports SetKeys.
		Which SetKey и dev:null								Х
			||	Begin										
					Which SetKeys и dev:null				Х
					&&	Begin								
						Alias SetKey SetKeys 				
						End									Х
					||	Begin								
						Alias SetKey '#' 				
						End									
				End
	
	
			# Execute in background.
			SetKey	Control-Return											 Х
					   '(Evaluate "`Position "{active}"`" =~				 Х
							/([0-9]*)е1 ([0-9]+)е2,([0-9]+)е3/ ) и Dev:Null	;Х
						If {е2} == {е3}	; Find {е1} "{active}" ; End		;Х
						ToolServer < "{active}".ц 							;Х
						Find	Ц!{е2}:Ц!{е3}	 "{active}"					'
						
			# Kill running background task.
			SetKey	Control-.												 Х
					   'Set pid 0											;Х
						Loop												;Х
							RShell -k {pid} && Break ; || Nothing			;Х
							Evaluate pid += 1								;Х
							Break If {pid} >= 16							;Х
						End и Dev:Null										'
		
			# Kill all background tasks.
			SetKey	Control-Shift-.											Х
					   'Set pid 0											;Х
						Loop												;Х
							RShell -k {pid} || Nothing						;Х
							Evaluate pid += 1								;Х
							Break If {pid} >= 16							;Х
						End и Dev:Null										'
		
			# Locate the source for the selected entrypoint.
			SetKey	Command-Option-D '"{sources}"Tools:LookupEntryPoint'

	End
#
#	Check Switch
#

	If	!{UseToolServer}
		Exit 0
	End

#
#	Patch the shell so that you can issue multiple commands
#

	{sources}Tools:PatchShell

#
#	Launch the ToolServer if running local, or locate it otherwise.
#

	Open -n -t "{TSWorkSheet}"
	
	If	"{ToolServer}" =~ /"ToolServer"/					# running local
		If	`Exists "{MPW}ToolServer"`
			Execute "{MPW}ToolServer"   			Х
				||	Begin
						Alert "I couldn't launch tool server."
						Exit 0
					End
			ToolServer		'"{MPW}MPW╩Shell"'
		Else
			Exit 0
		End
	Else
		ToolServer 'Nothing' и Dev:Null  			Х
			||	Begin
					Alert "I couldn't locate your tool server."
					Exit 0
				End
	End

#
#	Initialize ToolServer
#
	
	Set 	|	ToolServer
	Export	|	ToolServer
	Alias	|	ToolServer


#
#	Done
#

	Exit 0

#
#	End of BBSStartup
#
